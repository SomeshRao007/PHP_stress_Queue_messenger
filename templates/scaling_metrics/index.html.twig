{% extends 'base.html.twig' %}

{% block title %}Scaling Metrics â€” KEDA Comparison{% endblock %}

{% block body %}
<div class="mb-6 flex items-center justify-between">
    <div>
        <h2 class="text-2xl font-bold text-gray-900">KEDA Scaling Metrics</h2>
        <p class="text-gray-500 mt-1">Compare ScaledObject vs ScaledJob autoscaling behavior</p>
    </div>
    <a href="{{ path('dashboard') }}" class="text-indigo-600 hover:text-indigo-800 font-medium">
        &larr; Back to Dashboard
    </a>
</div>

<!-- Mode filter -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex items-center gap-4">
        <span class="text-sm font-medium text-gray-700">Filter by mode:</span>
        <button onclick="loadData('')" id="btn-all"
                class="px-3 py-1.5 text-sm rounded-md border transition-colors
                       {{ selectedMode == '' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50' }}">
            All
        </button>
        {% for mode in modes %}
        <button onclick="loadData('{{ mode }}')" id="btn-{{ mode }}"
                class="px-3 py-1.5 text-sm rounded-md border transition-colors
                       {{ selectedMode == mode ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50' }}">
            {{ mode }}
        </button>
        {% endfor %}
        <div class="ml-auto flex items-center gap-2">
            <label class="text-sm text-gray-600">
                <input type="checkbox" id="auto-refresh" class="mr-1"> Auto-refresh (30s)
            </label>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 gap-6">
    <!-- Queue Depth vs Active Pods -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Queue Depth vs Active Pods</h3>
        <canvas id="mainChart" height="100"></canvas>
    </div>

    <!-- Pod Breakdown -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Pod State Breakdown</h3>
        <canvas id="podChart" height="80"></canvas>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="stats">
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-3xl font-bold text-indigo-600" id="stat-total-points">0</div>
            <div class="text-sm text-gray-500">Data Points</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-3xl font-bold text-orange-500" id="stat-peak-queue">0</div>
            <div class="text-sm text-gray-500">Peak Queue Depth</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-3xl font-bold text-green-600" id="stat-peak-pods">0</div>
            <div class="text-sm text-gray-500">Peak Active Pods</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-3xl font-bold text-blue-600" id="stat-completed">0</div>
            <div class="text-sm text-gray-500">Total Completed</div>
        </div>
    </div>
</div>

<div class="mt-4 text-center text-sm text-gray-400">
    Data recorded by the scaling-monitor CronJob every minute
</div>
{% endblock %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
let mainChart, podChart;
let refreshInterval = null;

const mainCtx = document.getElementById('mainChart').getContext('2d');
const podCtx = document.getElementById('podChart').getContext('2d');

mainChart = new Chart(mainCtx, {
    type: 'line',
    data: { labels: [], datasets: [] },
    options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
            y: { type: 'linear', position: 'left', title: { display: true, text: 'Queue Depth' }, beginAtZero: true },
            y1: { type: 'linear', position: 'right', title: { display: true, text: 'Active Pods' }, beginAtZero: true, grid: { drawOnChartArea: false } }
        }
    }
});

podChart = new Chart(podCtx, {
    type: 'bar',
    data: { labels: [], datasets: [] },
    options: {
        responsive: true,
        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Pod Count' } } }
    }
});

function loadData(mode) {
    const url = '{{ path("scaling_metrics_api") }}' + (mode ? '?mode=' + mode : '');

    // Update button styles
    document.querySelectorAll('[id^="btn-"]').forEach(btn => {
        btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
        btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
    });
    const activeBtn = document.getElementById('btn-' + (mode || 'all'));
    if (activeBtn) {
        activeBtn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        activeBtn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
    }

    fetch(url)
        .then(r => r.json())
        .then(data => {
            const labels = data.map(d => d.recorded_at.split(' ')[1]);

            // Main chart: queue depth + active pods
            mainChart.data = {
                labels,
                datasets: [
                    {
                        label: 'Queue Depth',
                        data: data.map(d => d.queue_depth),
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        fill: true,
                        yAxisID: 'y',
                        tension: 0.3
                    },
                    {
                        label: 'Active Pods',
                        data: data.map(d => d.active_pods),
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        yAxisID: 'y1',
                        tension: 0.3
                    }
                ]
            };
            mainChart.update();

            // Pod breakdown chart
            podChart.data = {
                labels,
                datasets: [
                    { label: 'Active', data: data.map(d => d.active_pods), backgroundColor: '#22c55e' },
                    { label: 'Pending', data: data.map(d => d.pending_pods), backgroundColor: '#eab308' },
                    { label: 'Completed', data: data.map(d => d.completed_jobs), backgroundColor: '#3b82f6' },
                    { label: 'Failed', data: data.map(d => d.failed_jobs), backgroundColor: '#ef4444' }
                ]
            };
            podChart.update();

            // Stats
            document.getElementById('stat-total-points').textContent = data.length;
            document.getElementById('stat-peak-queue').textContent = data.length ? Math.max(...data.map(d => d.queue_depth)) : 0;
            document.getElementById('stat-peak-pods').textContent = data.length ? Math.max(...data.map(d => d.active_pods)) : 0;
            document.getElementById('stat-completed').textContent = data.length ? Math.max(...data.map(d => d.completed_jobs)) : 0;
        });
}

// Auto-refresh toggle
document.getElementById('auto-refresh').addEventListener('change', function() {
    if (this.checked) {
        refreshInterval = setInterval(() => {
            const activeBtn = document.querySelector('[id^="btn-"].bg-indigo-600');
            const mode = activeBtn ? activeBtn.id.replace('btn-', '').replace('all', '') : '';
            loadData(mode);
        }, 30000);
    } else {
        clearInterval(refreshInterval);
    }
});

// Initial load
loadData('{{ selectedMode }}');
</script>
{% endblock %}
